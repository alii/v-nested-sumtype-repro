name: Test

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  test:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
          - os: macos-latest
            name: macos
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Download V
        run: |
          if [ "${{ matrix.name }}" = "linux" ]; then
            curl -sL https://github.com/vlang/v/releases/latest/download/v_linux.zip -o /tmp/v.zip
          else
            curl -sL https://github.com/vlang/v/releases/latest/download/v_macos_arm64.zip -o /tmp/v.zip
          fi
          unzip -q /tmp/v.zip -d /tmp
          echo "/tmp/v" >> $GITHUB_PATH

      - name: V Doctor
        run: v doctor

      - name: Build (Production with debug symbols)
        if: matrix.name == 'linux'
        run: v -prod -g -o repro_prod repro.v

      - name: Build (Production)
        if: matrix.name != 'linux'
        run: v -prod -o repro_prod repro.v

      - name: Run (Production)
        id: run_prod
        run: ./repro_prod 2>&1 || true
        continue-on-error: true

      - name: Get detailed stack trace
        if: matrix.name == 'linux'
        run: |
          echo "=== Attempting to get detailed stack trace with addr2line ==="
          # Extract addresses from the crash and resolve them
          ./repro_prod 2>&1 | grep -oP '\+0x[0-9a-f]+' | while read addr; do
            echo "Address $addr:"
            addr2line -e repro_prod -f -C ${addr#+} 2>/dev/null || echo "  (could not resolve)"
          done
        continue-on-error: true

      - name: Build (O2) - Linux only
        if: matrix.name == 'linux'
        run: v -cc gcc -cflags "-O2" -o repro_o2 repro.v

      - name: Run (O2) - Linux only
        if: matrix.name == 'linux'
        run: ./repro_o2
