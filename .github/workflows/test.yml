name: Test

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  test:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
          - os: macos-latest
            name: macos
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Download V
        run: |
          if [ "${{ matrix.name }}" = "linux" ]; then
            curl -sL https://github.com/vlang/v/releases/latest/download/v_linux.zip -o /tmp/v.zip
          else
            curl -sL https://github.com/vlang/v/releases/latest/download/v_macos_arm64.zip -o /tmp/v.zip
          fi
          unzip -q /tmp/v.zip -d /tmp
          echo "/tmp/v" >> $GITHUB_PATH

      - name: Build (Debug)
        run: v -o repro_debug repro.v

      - name: Run (Debug)
        run: ./repro_debug

      - name: Build (Production)
        run: v -prod -o repro_prod repro.v

      - name: Run (Production) - 13 variants EXPECTED TO CRASH on Linux
        if: matrix.name != 'linux'
        run: ./repro_prod

      - name: Run (Production) - 13 variants CRASHES on Linux (expected)
        if: matrix.name == 'linux'
        continue-on-error: true
        run: |
          if ./repro_prod; then
            echo "UNEXPECTED: 13-variant version worked!"
          else
            echo "EXPECTED: 13-variant version crashed with exit code $?"
          fi

      - name: Build (O2 only)
        if: matrix.name == 'linux'
        run: v -cc gcc -cflags "-O2" -o repro_o2 repro.v

      - name: Run (O2 only)
        if: matrix.name == 'linux'
        run: ./repro_o2

      - name: Build 12-variant (Production) - should work
        if: matrix.name == 'linux'
        run: v -prod -o repro_12_prod repro_12.v

      - name: Run 12-variant (Production) - should work
        if: matrix.name == 'linux'
        run: ./repro_12_prod
